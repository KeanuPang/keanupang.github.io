<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>web-service | Living today for tomorrow</title><meta name=keywords content><meta name=description content="Living today for tomorrow"><meta name=author content="Keanu Pang"><link rel=canonical href=https://keanupang.github.io/tags/web-service/><link crossorigin=anonymous href=/assets/css/stylesheet.d7fb4cbf980fe688a21621b06a795933c4e6bb2d4070ec940667af1715d84af2.css integrity="sha256-1/tMv5gP5oiiFiGwanlZM8Tmuy1AcOyUBmevFxXYSvI=" rel="preload stylesheet" as=style><link rel=icon href=https://keanupang.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://keanupang.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://keanupang.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://keanupang.github.io/apple-touch-icon.png><link rel=mask-icon href=https://keanupang.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://keanupang.github.io/tags/web-service/index.xml><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="web-service"><meta property="og:description" content="Living today for tomorrow"><meta property="og:type" content="website"><meta property="og:url" content="https://keanupang.github.io/tags/web-service/"><meta name=twitter:card content="summary"><meta name=twitter:title content="web-service"><meta name=twitter:description content="Living today for tomorrow"></head><body class=list id=top><header class=header><nav class=nav><div class=logo><a href=https://keanupang.github.io accesskey=h title="Living today for tomorrow (Alt + H)">Living today for tomorrow</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://keanupang.github.io/about title=About><span>About</span></a></li><li><a href=https://keanupang.github.io/posts title=Posts><span>Posts</span></a></li></ul></nav></header><main class=main><header class=page-header><h1>web-service</h1></header><article class="post-entry tag-entry"><header class=entry-header><h2>套件組合技經驗：JSON Server</h2></header><div class=entry-content><p>前陣子因為在開發環境需要有個簡易又不會太粗糙的 mock server，所以快速用短短的時間把幾個套件組合串起來，成為基本可用的迷你 project，最主要還是拜豐富 NodeJS 的生態系所賜，很多東西都有現成可用幾乎不用多寫幾行程式碼，原則上就是可以推到開發環境。
一開始先找到最熱門的 json server 就是 typicode 的專案，跑起來基本上已經符合需求，所以從這邊開始來組合。
如果是用程式碼方式建立 json server 來做客製化，其實骨子裡就是 express web framework，所以用法都是一樣：
const https = require("https"); const devcert = require("devcert"); const jsonServer = require("json-server"); const server = jsonServer.create(); server.use(jsonServer.defaults()); server.use(jsonServer.rewriter(require("./routes.json"))); server.use(jsonServer.router("api.json")); async function start() { let ssl = await devcert.certificateFor("api.dev"); https.createServer(ssl, server).listen(8443); } start(); 開發環境希望也是走 HTTPS 方式所以用到 devcert 掛了一個自簽的開發用憑證就可以跑 HTTPS 了，如上幾乎就是開箱即用的 server。
由於需要 db.json 檔裡面就是擺好被視為資料庫的 JSON 內容，然後依 request 的 HTTP method 進行資料的 CRUD，但也因為這個很棒的特性所以為了我自己的需求只好魔改原本程式變成 json-server-deformation。...</p></div><footer class=entry-footer><span title='2022-07-04 00:00:18 +0800 +0800'>July 4, 2022</span>&nbsp;·&nbsp;Keanu Pang</footer><a class=entry-link aria-label="post link to 套件組合技經驗：JSON Server" href=https://keanupang.github.io/posts/json-server-deformation/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>試玩 Hummingbird 的 middleware</h2></header><div class=entry-content><p>之前為了測試 Hummingbird 這個輕量 server framework 所以做了一個叫 LocalWeb 的 web project，主要是用來讓使用者在開發環境下方便地瀏覽與下載檔案；結果沒想到內建的 middleware 就幾乎把所有事情都搞定了。
當然還是要再加點工才可以方便使用，例如當我點進目錄時，希望可以一覽目錄下的檔案清單，所以就客製化做了個 middleware 掛上來，把目錄下的檔案展開成清單做成連結讓使用者可以下載，當使用者點到檔案時就直接串到 HBFileMiddleware 下載檔案這樣。
第一次嘗試實作 Hummingbird 的 middleware 所以花了點時間研究，目前實作版本可以參考這 DirectoryIndexMiddleware ，還好進入門檻不高就是，花最多時間反而是在刻呈現頁面的 html。
因為想呈現那種傳統 Apache web server 檢視目錄下的復古感，於是參考 HBResponseGenerator 這個 protocol，是用來產生 response 結果頁，基本上只要實作 func response(from request: HBRequest) 把刻好的 html 產生成 HBResponse 結果就可以。
成品像是這樣 DirectoryIndexPage 會在剛剛的 DirectoryIndexMiddleware 裡被用到回傳 response。
為了求快所以先不套用什麼 template engine，直接用 String 拼出來，之後有時間再研究看看 Stencil 還是 Leaf 哪個好用。
雛型差不多完成之後，想說要掛個 HTTPS 功能結果好像沒有那麼直覺。本來以為只要把 Configuration 裡的 tlsOptions 設定上去就好，然後就會被噴 warning 訊息：
tlsOptions set in Configuration will not be applied to a BSD sockets server....</p></div><footer class=entry-footer><span title='2022-06-28 02:05:11 +0800 +0800'>June 28, 2022</span>&nbsp;·&nbsp;Keanu Pang</footer><a class=entry-link aria-label="post link to 試玩 Hummingbird 的 middleware" href=https://keanupang.github.io/posts/side-project-hummingbird-localweb/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>建立 DynamoDB 的 Incremental ID 機制</h2></header><div class=entry-content><p>需要在 DynamoDB 的某個 table 的 Hash Key 是用 auto increment 的方式儲存 id，不過如果只單靠一張 table 有點難完成這樣的機制，所以需要再生另一張 table 用來存放目前的值，讓原本的 table 可以去參考以取得新增後的數值回來儲存。
可以參考這篇：How to make a UUID in DynamoDB?，做法大概就是像這樣：
Each time you want to generate a new id, you would do the following:
Do a GetItem on NextIdTable to read the current value of Counter → curValue
Do a PutItem on NextIdTable to set the value of Counter to curValue + 1. Make this a conditional > PutItem so that it will fail if the value of Counter has changed....</p></div><footer class=entry-footer><span title='2017-12-12 00:00:00 +0000 UTC'>December 12, 2017</span>&nbsp;·&nbsp;Keanu Pang</footer><a class=entry-link aria-label="post link to 建立 DynamoDB 的 Incremental ID 機制" href=https://keanupang.github.io/posts/dynamodb-incremental-id/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>Connect-Redis 套件更新 Session 過期時間的方式</h2></header><div class=entry-content><p>在使用 Express 架設網站時，且因為 cluster 的考量，會將 Session cookie 的資訊往外拉，通常都是使用 Redis 來儲存使用者的 Session。在 Express 裡會透過 connect-redis 的套件來串接兩者，以及使用者登入的檢查就使用 passport 套件來幫我們完成。
在 Express 裡的設定結構大概會是這樣︰
let sessionMiddleware = session({ store: new RedisStore({ host: hostname, port: port, db: db * 1, ttl: 3600 }), resave: false, saveUninitialized: false }); app.middleware(‘session’, sessionMiddleware); 這時候的困難點會是當未登入的使用者可能需要 session cookie 的 maxAge 會比較短期，例如需要是處在 recaptcha 的驗證階段；直到使用者順利登入後，才需要更新 session cookie 的 maxAge 為合理的時間。也就是 Redis 的 TTL 設定是動態的方式調整。
參考這裡的 討論 的做法則會是固定將 TTL 設為 0，並在使用者登入後才更新 maxAge。所以 RedisStore 的設定將會是︰...</p></div><footer class=entry-footer><span title='2016-11-14 00:00:00 +0000 UTC'>November 14, 2016</span>&nbsp;·&nbsp;Keanu Pang</footer><a class=entry-link aria-label="post link to Connect-Redis 套件更新 Session 過期時間的方式" href=https://keanupang.github.io/posts/configure-redis-session-timeout/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>自定 Retrofit 的 DELETE Annotation</h2></header><div class=entry-content><p>一般使用 Jersey 或 RESTEasy 所建立的 JAX-RS Web Service，是允許 client 呼叫 DELETE method 時可以加上 Message Body，就跟 POST method 一樣我們可以取得 Body 裡的內容。
但 Client 如果是使用 Retrofit 來呼叫 Web Service 的 DELETE method 並且加上 Body annotation 夾帶資料過去時，卻會得到如下的訊息而被中止︰
Non-body HTTP method cannot contain @Body or @TypedOutput. 對 Retrofit 來說是照著 W3C 的標準去實作，於是這樣的行為就跟一般坊間的 http client 不太一樣。
最快的方法就是自定一個可以允許夾帶資料的 DELETE Annotation，讓 Retrofit 可以參照︰
import static java.lang.annotation.ElementType.METHOD; import static java.lang.annotation.RetentionPolicy.RUNTIME; import java.lang.annotation.Retention; import java.lang.annotation.Target; import retrofit.http.RestMethod; @Target(METHOD) @Retention(RUNTIME) @RestMethod(value = “DELETE”, hasBody = true) public @interface DELETE { String value(); } 然後在自己的 Retrofit Service 使用這個 DELETE annotation 就可以了︰...</p></div><footer class=entry-footer><span title='2016-05-04 00:00:00 +0000 UTC'>May 4, 2016</span>&nbsp;·&nbsp;Keanu Pang</footer><a class=entry-link aria-label="post link to 自定 Retrofit 的 DELETE Annotation" href=https://keanupang.github.io/posts/custom-retrofit-delete-annotation/></a></article></main><footer class=footer><span>&copy; 2023 <a href=https://keanupang.github.io>Living today for tomorrow</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>